<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹æˆ˜å‡†å¤‡ - å•è¯é—¯å…³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #4f46e5 0%, #ec4899 100%);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        .countdown {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .vs-text {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fff; }
            to { text-shadow: 0 0 20px #fff, 0 0 30px #fff, 0 0 40px #fff; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen text-white p-8">

    <div class="w-full max-w-4xl bg-white/30 backdrop-blur-lg rounded-xl p-8 md:p-12 shadow-xl text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-8">æ‰¾åˆ°å¯¹æ‰‹ï¼</h1>

        <!-- å¯¹æ‰‹ä¿¡æ¯å¯¹æ¯” -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8 items-center">
            <!-- æˆ‘çš„ä¿¡æ¯ -->
            <div class="bg-blue-500/30 rounded-lg p-6">
                <div class="w-20 h-20 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span class="text-2xl">ğŸ‘¤</span>
                </div>
                <h3 id="myNickname" class="text-xl font-bold mb-2">æˆ‘çš„æ˜µç§°</h3>
                <p id="myGrade" class="text-lg mb-1">äº”å¹´çº§</p>
                <p class="text-sm opacity-75">ç­‰çº§: Lv.<span id="myLevel">1</span></p>
                <p class="text-sm opacity-75">èƒœç‡: <span id="myWinRate">0</span>%</p>
            </div>

            <!-- VS -->
            <div class="flex items-center justify-center">
                <span class="vs-text text-6xl font-bold">VS</span>
            </div>

            <!-- å¯¹æ‰‹ä¿¡æ¯ -->
            <div class="bg-red-500/30 rounded-lg p-6">
                <div class="w-20 h-20 bg-red-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span class="text-2xl">ğŸ¤–</span>
                </div>
                <h3 id="opponentNickname" class="text-xl font-bold mb-2">å¯¹æ‰‹æ˜µç§°</h3>
                <p id="opponentGrade" class="text-lg mb-1">äº”å¹´çº§</p>
                <p class="text-sm opacity-75">ç­‰çº§: Lv.<span id="opponentLevel">1</span></p>
                <p class="text-sm opacity-75">èƒœç‡: <span id="opponentWinRate">0</span>%</p>
            </div>
        </div>

        <!-- æ¸¸æˆä¿¡æ¯ -->
        <div class="bg-white/20 rounded-lg p-6 mb-8">
            <h3 class="text-2xl font-bold mb-4">æ¸¸æˆä¿¡æ¯</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left">
                <div>
                    <p class="font-semibold">å…³å¡ä¸€: <span class="text-yellow-300">è­¦å¯ŸæŠ“å°å·</span></p>
                    <p class="text-sm opacity-75">ä¸­è¯‘è‹±å¡«ç©º</p>
                </div>
                <div>
                    <p class="font-semibold">å…³å¡äºŒ: <span class="text-yellow-300">ç™»å¤©æ¢¯</span></p>
                    <p class="text-sm opacity-75">è‹±è¯‘ä¸­é€‰æ‹©</p>
                </div>
                <div>
                    <p class="font-semibold">å…³å¡ä¸‰: <span class="text-yellow-300">è¯åŠ›æ‹”æ²³</span></p>
                    <p class="text-sm opacity-75">å¬éŸ³è¾¨è¯</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-white/20">
                <p>è¯åº“: <span id="wordBank" class="font-semibold text-yellow-300">äº”å¹´çº§ä¸Šå†Œ</span></p>
                <p>è§„åˆ™: ä¸‰å…³ä¸¤èƒœåˆ¶ï¼Œæ¯å…³å°æ¸¸æˆå†³å®šèƒœè´Ÿ</p>
            </div>
        </div>

        <!-- å€’è®¡æ—¶ -->
        <div class="mb-8">
            <p class="text-2xl mb-4">å€’è®¡æ—¶: <span id="countdown" class="countdown text-4xl font-bold text-yellow-300">5</span>ç§’åå¼€å§‹</p>
            <div class="w-full bg-white/20 rounded-full h-3">
                <div id="progressBar" class="bg-yellow-300 h-3 rounded-full transition-all duration-1000" style="width: 100%"></div>
            </div>
        </div>

        <!-- å‡†å¤‡çŠ¶æ€ -->
        <div id="readyStatus" class="text-lg opacity-75">
            ç­‰å¾…æ¸¸æˆå¼€å§‹...
        </div>
    </div>

    <script>
        const myNickname = document.getElementById('myNickname');
        const myGrade = document.getElementById('myGrade');
        const myLevel = document.getElementById('myLevel');
        const myWinRate = document.getElementById('myWinRate');

        const opponentNickname = document.getElementById('opponentNickname');
        const opponentGrade = document.getElementById('opponentGrade');
        const opponentLevel = document.getElementById('opponentLevel');
        const opponentWinRate = document.getElementById('opponentWinRate');

        const wordBank = document.getElementById('wordBank');
        const countdownElement = document.getElementById('countdown');
        const progressBar = document.getElementById('progressBar');
        const readyStatus = document.getElementById('readyStatus');

        let countdownTime = 5;
        let countdownTimer = null;
        let isReady = false;
        let opponentReady = false;

        // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
        function initializeUserInfo() {
            // æˆ‘çš„ä¿¡æ¯
            if (window.parent && window.parent.battleUserInfo) {
                const userInfo = window.parent.battleUserInfo;
                myNickname.textContent = userInfo.nickname || 'æˆ‘çš„æ˜µç§°';
                myGrade.textContent = userInfo.gradeName || 'äº”å¹´çº§';
                wordBank.textContent = `${userInfo.gradeName || 'äº”å¹´çº§'}ä¸Šå†Œ`;

                // æ¨¡æ‹Ÿç”¨æˆ·ç­‰çº§å’Œèƒœç‡ (å®é™…åº”è¯¥ä»ç”¨æˆ·æ•°æ®ä¸­è·å–)
                myLevel.textContent = '1';
                myWinRate.textContent = '0';
            }

            // å¯¹æ‰‹ä¿¡æ¯
            if (window.parent && window.parent.opponentInfo) {
                const opponent = window.parent.opponentInfo;
                opponentNickname.textContent = opponent.nickname || 'å¯¹æ‰‹æ˜µç§°';
                opponentGrade.textContent = opponent.grade || 'äº”å¹´çº§';
                opponentLevel.textContent = '1';
                opponentWinRate.textContent = opponent.winRate || '0';
            }

            // ç›‘å¬æˆ¿é—´å°±ç»ªäº‹ä»¶
            if (window.parent && window.parent.firebaseBattle) {
                window.parent.firebaseBattle.on('roomReady', () => {
                    console.log('ğŸ  æ”¶åˆ°æˆ¿é—´å°±ç»ªäº‹ä»¶ï¼Œå¼€å§‹è®¾ç½®å‡†å¤‡çŠ¶æ€');
                    readyRetryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
                    setTimeout(() => {
                        setPlayerReady();
                    }, 500);
                });
            }
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šå»¶è¿Ÿè®¾ç½®å‡†å¤‡çŠ¶æ€ï¼Œç­‰å¾…Firebaseæˆ¿é—´åˆå§‹åŒ–å®Œæˆ
            setTimeout(() => {
                if (!isReady) {
                    console.log('ğŸ”„ å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥å°è¯•è®¾ç½®å‡†å¤‡çŠ¶æ€');
                    setPlayerReady();
                }
            }, 3000);
        }

        // å¼€å§‹å€’è®¡æ—¶
        function startCountdown() {
            countdownTimer = setInterval(() => {
                countdownTime--;
                countdownElement.textContent = countdownTime;

                // æ›´æ–°è¿›åº¦æ¡
                const progress = (countdownTime / 5) * 100;
                progressBar.style.width = `${progress}%`;

                // æ’­æ”¾å€’è®¡æ—¶éŸ³æ•ˆ
                if (window.parent && typeof window.parent.playSound === 'function') {
                    if (countdownTime <= 3 && countdownTime > 0) {
                        window.parent.playSound('countdown');
                    }
                }

                if (countdownTime <= 0) {
                    clearInterval(countdownTimer);
                    startGame();
                }
            }, 1000);
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            readyStatus.textContent = 'æ¸¸æˆå¼€å§‹ï¼';

            // æ’­æ”¾æ¸¸æˆå¼€å§‹éŸ³æ•ˆ
            if (window.parent && typeof window.parent.playSound === 'function') {
                window.parent.playSound('gameStart');
            }

            // å‡†å¤‡æ¸¸æˆæ•°æ®ï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
            const playerInfo = window.parent.battleUserInfo || {};
            const opponentInfo = window.parent.opponentInfo || {};

            // ç”Ÿæˆç¡®å®šæ€§çš„æˆ¿é—´IDï¼ˆåŸºäºç©å®¶ä¿¡æ¯ï¼‰
            const playerId = playerInfo.id || playerInfo.nickname || 'player1';
            const opponentId = opponentInfo.id || opponentInfo.nickname || 'opponent1';
            const sortedIds = [playerId, opponentId].sort(); // æŒ‰å­—å…¸åºæ’åºç¡®ä¿ä¸€è‡´æ€§
            const deterministicRoomId = `room_${sortedIds[0]}_${sortedIds[1]}_${Date.now()}`;

            const gameData = {
                player: {
                    ...playerInfo,
                    id: playerId
                },
                opponent: {
                    ...opponentInfo,
                    id: opponentId
                },
                roomId: deterministicRoomId,
                currentLevel: 1,
                gameMode: 'battle'
            };

            console.log('ğŸ® å‡†å¤‡æ¸¸æˆæ•°æ®:', gameData);

            // å­˜å‚¨æ¸¸æˆæ•°æ®åˆ°çˆ¶é¡µé¢
            if (window.parent) {
                window.parent.battleGameData = gameData;
            }

            // å»¶è¿Ÿ1ç§’åå¯åŠ¨åŒäººå¯¹æˆ˜æ¸¸æˆ
            setTimeout(() => {
                if (window.parent && window.parent.postMessage) {
                    window.parent.postMessage({ action: 'startBattleGame' }, '*');
                }
            }, 1000);
        }

        // è®¾ç½®ç©å®¶å‡†å¤‡çŠ¶æ€
        let readyRetryCount = 0;
        const maxReadyRetries = 10;
        
        async function setPlayerReady() {
            readyRetryCount++;
            console.log(`ğŸ” å°è¯•è®¾ç½®å‡†å¤‡çŠ¶æ€ (ç¬¬${readyRetryCount}æ¬¡)`);
            
            if (!window.parent || !window.parent.firebaseBattle) {
                console.log('â³ Firebase Battleæœªåˆå§‹åŒ–');
                if (readyRetryCount < maxReadyRetries) {
                    setTimeout(() => setPlayerReady(), 1000);
                }
                return;
            }
            
            const firebaseBattle = window.parent.firebaseBattle;
            
            if (!firebaseBattle.roomRef || !firebaseBattle.currentUser || !firebaseBattle.currentRoom) {
                console.log('â³ Firebaseæˆ¿é—´æœªå®Œå…¨å°±ç»ªï¼Œç­‰å¾…ä¸­...');
                console.log('ğŸ” roomRef:', !!firebaseBattle.roomRef);
                console.log('ğŸ” currentUser:', !!firebaseBattle.currentUser);
                console.log('ğŸ” currentRoom:', firebaseBattle.currentRoom);
                
                if (readyRetryCount < maxReadyRetries) {
                    setTimeout(() => setPlayerReady(), 1000);
                }
                return;
            }
            
            try {
                console.log('ğŸ“ å¼€å§‹è®¾ç½®å‡†å¤‡çŠ¶æ€...');
                const success = await firebaseBattle.setPlayerReady(true);
                
                if (success) {
                    isReady = true;
                    console.log('âœ… æˆåŠŸè®¾ç½®è‡ªå·±ä¸ºå‡†å¤‡çŠ¶æ€');
                    readyStatus.textContent = 'ç­‰å¾…å¯¹æ‰‹å‡†å¤‡...';
                } else {
                    console.log('âŒ è®¾ç½®å‡†å¤‡çŠ¶æ€å¤±è´¥ï¼Œé‡è¯•ä¸­...');
                    if (readyRetryCount < maxReadyRetries) {
                        setTimeout(() => setPlayerReady(), 1000);
                    } else {
                        console.error('âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè®¾ç½®å‡†å¤‡çŠ¶æ€å¤±è´¥');
                        readyStatus.textContent = 'å‡†å¤‡çŠ¶æ€è®¾ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                    }
                }
            } catch (error) {
                console.error('âŒ è®¾ç½®å‡†å¤‡çŠ¶æ€å¼‚å¸¸:', error);
                if (readyRetryCount < maxReadyRetries) {
                    setTimeout(() => setPlayerReady(), 1000);
                }
            }
        }

        // ç›‘å¬æ‰€æœ‰ç©å®¶å‡†å¤‡äº‹ä»¶
        function setupReadyListener() {
            if (window.parent && window.parent.firebaseBattle) {
                window.parent.firebaseBattle.on('allPlayersReady', () => {
                    console.log('ğŸ® æ‰€æœ‰ç©å®¶å·²å‡†å¤‡ï¼Œå¼€å§‹å€’è®¡æ—¶ï¼');
                    readyStatus.textContent = 'æ‰€æœ‰ç©å®¶å·²å‡†å¤‡ï¼';

                    // å»¶è¿Ÿ1ç§’åå¼€å§‹å€’è®¡æ—¶
                    setTimeout(() => {
                        startCountdown();
                    }, 1000);
                });
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initializeUserInfo();
            setupReadyListener();

            // å¦‚æœæ˜¯AIå¯¹æ‰‹ï¼Œç›´æ¥å¼€å§‹å€’è®¡æ—¶
            if (window.parent && window.parent.opponentInfo &&
                window.parent.opponentInfo.nickname === 'AIåŠ©æ‰‹') {
                console.log('ğŸ¤– AIå¯¹æ‰‹æ¨¡å¼ï¼Œç›´æ¥å¼€å§‹å€’è®¡æ—¶');
                setTimeout(() => {
                    startCountdown();
                }, 2000);
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
        });
    </script>
</body>
</html>
