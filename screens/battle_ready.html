<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹æˆ˜å‡†å¤‡ - å•è¯é—¯å…³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #4f46e5 0%, #ec4899 100%);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        .countdown {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .vs-text {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fff; }
            to { text-shadow: 0 0 20px #fff, 0 0 30px #fff, 0 0 40px #fff; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen text-white p-8">

    <div class="w-full max-w-4xl bg-white/30 backdrop-blur-lg rounded-xl p-8 md:p-12 shadow-xl text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-8">æ‰¾åˆ°å¯¹æ‰‹ï¼</h1>

        <!-- å¯¹æ‰‹ä¿¡æ¯å¯¹æ¯” -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8 items-center">
            <!-- æˆ‘çš„ä¿¡æ¯ -->
            <div class="bg-blue-500/30 rounded-lg p-6">
                <div class="w-20 h-20 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span class="text-2xl">ğŸ‘¤</span>
                </div>
                <h3 id="myNickname" class="text-xl font-bold mb-2">æˆ‘çš„æ˜µç§°</h3>
                <p id="myGrade" class="text-lg mb-1">äº”å¹´çº§</p>
                <p class="text-sm opacity-75">ç­‰çº§: Lv.<span id="myLevel">1</span></p>
                <p class="text-sm opacity-75">èƒœç‡: <span id="myWinRate">0</span>%</p>
            </div>

            <!-- VS -->
            <div class="flex items-center justify-center">
                <span class="vs-text text-6xl font-bold">VS</span>
            </div>

            <!-- å¯¹æ‰‹ä¿¡æ¯ -->
            <div class="bg-red-500/30 rounded-lg p-6">
                <div class="w-20 h-20 bg-red-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span class="text-2xl">ğŸ¤–</span>
                </div>
                <h3 id="opponentNickname" class="text-xl font-bold mb-2">å¯¹æ‰‹æ˜µç§°</h3>
                <p id="opponentGrade" class="text-lg mb-1">äº”å¹´çº§</p>
                <p class="text-sm opacity-75">ç­‰çº§: Lv.<span id="opponentLevel">1</span></p>
                <p class="text-sm opacity-75">èƒœç‡: <span id="opponentWinRate">0</span>%</p>
            </div>
        </div>

        <!-- æ¸¸æˆä¿¡æ¯ -->
        <div class="bg-white/20 rounded-lg p-6 mb-8">
            <h3 class="text-2xl font-bold mb-4">æ¸¸æˆä¿¡æ¯</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left">
                <div>
                    <p class="font-semibold">å…³å¡ä¸€: <span class="text-yellow-300">è­¦å¯ŸæŠ“å°å·</span></p>
                    <p class="text-sm opacity-75">ä¸­è¯‘è‹±å¡«ç©º</p>
                </div>
                <div>
                    <p class="font-semibold">å…³å¡äºŒ: <span class="text-yellow-300">ç™»å¤©æ¢¯</span></p>
                    <p class="text-sm opacity-75">è‹±è¯‘ä¸­é€‰æ‹©</p>
                </div>
                <div>
                    <p class="font-semibold">å…³å¡ä¸‰: <span class="text-yellow-300">è¯åŠ›æ‹”æ²³</span></p>
                    <p class="text-sm opacity-75">å¬éŸ³è¾¨è¯</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-white/20">
                <p>è¯åº“: <span id="wordBank" class="font-semibold text-yellow-300">äº”å¹´çº§ä¸Šå†Œ</span></p>
                <p>è§„åˆ™: ä¸‰å…³ä¸¤èƒœåˆ¶ï¼Œæ¯å…³å°æ¸¸æˆå†³å®šèƒœè´Ÿ</p>
            </div>
        </div>

        <!-- å€’è®¡æ—¶ -->
        <div class="mb-8">
            <p class="text-2xl mb-4">å€’è®¡æ—¶: <span id="countdown" class="countdown text-4xl font-bold text-yellow-300">5</span>ç§’åå¼€å§‹</p>
            <div class="w-full bg-white/20 rounded-full h-3">
                <div id="progressBar" class="bg-yellow-300 h-3 rounded-full transition-all duration-1000" style="width: 100%"></div>
            </div>
        </div>

        <!-- å‡†å¤‡çŠ¶æ€ -->
        <div id="readyStatus" class="text-lg opacity-75">
            ç­‰å¾…æ¸¸æˆå¼€å§‹...
        </div>
    </div>

    <script>
        const myNickname = document.getElementById('myNickname');
        const myGrade = document.getElementById('myGrade');
        const myLevel = document.getElementById('myLevel');
        const myWinRate = document.getElementById('myWinRate');

        const opponentNickname = document.getElementById('opponentNickname');
        const opponentGrade = document.getElementById('opponentGrade');
        const opponentLevel = document.getElementById('opponentLevel');
        const opponentWinRate = document.getElementById('opponentWinRate');

        const wordBank = document.getElementById('wordBank');
        const countdownElement = document.getElementById('countdown');
        const progressBar = document.getElementById('progressBar');
        const readyStatus = document.getElementById('readyStatus');

        let countdownTime = 5;
        let countdownTimer = null;

        // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
        function initializeUserInfo() {
            // æˆ‘çš„ä¿¡æ¯
            if (window.parent && window.parent.battleUserInfo) {
                const userInfo = window.parent.battleUserInfo;
                myNickname.textContent = userInfo.nickname || 'æˆ‘çš„æ˜µç§°';
                myGrade.textContent = userInfo.gradeName || 'äº”å¹´çº§';
                wordBank.textContent = `${userInfo.gradeName || 'äº”å¹´çº§'}ä¸Šå†Œ`;

                // æ¨¡æ‹Ÿç”¨æˆ·ç­‰çº§å’Œèƒœç‡ (å®é™…åº”è¯¥ä»ç”¨æˆ·æ•°æ®ä¸­è·å–)
                myLevel.textContent = '1';
                myWinRate.textContent = '0';
            }

            // å¯¹æ‰‹ä¿¡æ¯
            if (window.parent && window.parent.opponentInfo) {
                const opponent = window.parent.opponentInfo;
                opponentNickname.textContent = opponent.nickname || 'å¯¹æ‰‹æ˜µç§°';
                opponentGrade.textContent = opponent.grade || 'äº”å¹´çº§';
                opponentLevel.textContent = '1';
                opponentWinRate.textContent = opponent.winRate || '0';
            }
        }

        // å¼€å§‹å€’è®¡æ—¶
        function startCountdown() {
            countdownTimer = setInterval(() => {
                countdownTime--;
                countdownElement.textContent = countdownTime;

                // æ›´æ–°è¿›åº¦æ¡
                const progress = (countdownTime / 5) * 100;
                progressBar.style.width = `${progress}%`;

                // æ’­æ”¾å€’è®¡æ—¶éŸ³æ•ˆ
                if (window.parent && typeof window.parent.playSound === 'function') {
                    if (countdownTime <= 3 && countdownTime > 0) {
                        window.parent.playSound('countdown');
                    }
                }

                if (countdownTime <= 0) {
                    clearInterval(countdownTimer);
                    startGame();
                }
            }, 1000);
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            readyStatus.textContent = 'æ¸¸æˆå¼€å§‹ï¼';

            // æ’­æ”¾æ¸¸æˆå¼€å§‹éŸ³æ•ˆ
            if (window.parent && typeof window.parent.playSound === 'function') {
                window.parent.playSound('gameStart');
            }

            // å‡†å¤‡æ¸¸æˆæ•°æ®
            const gameData = {
                player: {
                    ...window.parent.battleUserInfo,
                    id: window.parent.battleUserInfo?.id || window.parent.battleUserInfo?.nickname || 'player1'
                },
                opponent: window.parent.opponentInfo,
                roomId: window.parent.currentRoomId || 'default_room',
                currentLevel: 1,
                gameMode: 'battle'
            };

            console.log('ğŸ® å‡†å¤‡æ¸¸æˆæ•°æ®:', gameData);

            // å­˜å‚¨æ¸¸æˆæ•°æ®åˆ°çˆ¶é¡µé¢
            if (window.parent) {
                window.parent.battleGameData = gameData;
            }

            // å»¶è¿Ÿ1ç§’åå¯åŠ¨åŒäººå¯¹æˆ˜æ¸¸æˆ
            setTimeout(() => {
                if (window.parent && window.parent.postMessage) {
                    window.parent.postMessage({ action: 'startBattleGame' }, '*');
                }
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initializeUserInfo();

            // å»¶è¿Ÿ1ç§’åå¼€å§‹å€’è®¡æ—¶ï¼Œè®©ç”¨æˆ·æœ‰æ—¶é—´æŸ¥çœ‹ä¿¡æ¯
            setTimeout(() => {
                startCountdown();
            }, 1000);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
        });
    </script>
</body>
</html>
