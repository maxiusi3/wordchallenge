<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹æˆ˜ç»“æœ - å•è¯é—¯å…³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            /* åŒäººå¯¹æˆ˜ç»“æœé¡µèƒŒæ™¯ */
            background: linear-gradient(135deg, #1e40af 0%, #7c3aed 50%, #dc2626 100%);
            font-family: 'Arial', sans-serif;
            overflow-y: auto;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .result-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .result-title {
            text-align: center;
            margin-bottom: 24px;
        }

        .result-title.victory {
            color: #10b981;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .result-title.defeat {
            color: #ef4444;
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        .players-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 32px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .player-info {
            text-align: center;
            padding: 16px;
            border-radius: 12px;
        }

        .my-info {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.3);
        }

        .opponent-info {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            border: 3px solid;
        }

        .my-avatar {
            background: #3b82f6;
            border-color: #1e40af;
        }

        .opponent-avatar {
            background: #ef4444;
            border-color: #dc2626;
        }

        .vs-divider {
            font-size: 48px;
            font-weight: bold;
            color: #fbbf24;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        .level-results {
            margin-bottom: 32px;
        }

        .level-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid;
        }

        .level-result-item.victory {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .level-result-item.defeat {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .level-result-item.draw {
            border-left-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        /* é”™é¢˜æ±‡æ€»æ ·å¼ - ä¿ç•™åŸæœ‰è®¾è®¡ */
        .wrong-answers-section {
            margin-bottom: 32px;
        }

        .wrong-answers-container {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
        }

        .wrong-answer-item {
            background: rgba(255, 255, 255, 0.9);
            color: #1f2937;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #ef4444;
        }

        .wrong-answer-item:last-child {
            margin-bottom: 0;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-button {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 140px;
        }

        .primary-button {
            background: #10b981;
            color: white;
        }

        .primary-button:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .secondary-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .secondary-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .players-comparison {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .vs-divider {
                font-size: 32px;
                margin: 8px 0;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .action-button {
                width: 100%;
                max-width: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="result-container">
        <!-- 1. èƒœè´Ÿç»“æœæ ‡é¢˜ -->
        <div id="result-title" class="result-title">
            <h1 class="text-4xl md:text-6xl font-bold mb-4">ğŸ† èƒœåˆ©ï¼ğŸ†</h1>
            <p class="text-xl opacity-75">æ­å–œä½ åœ¨å¯¹æˆ˜ä¸­è·èƒœï¼</p>
        </div>

        <!-- 2. åŒæ–¹å¯¹æ¯” -->
        <div class="players-comparison">
            <!-- æˆ‘çš„ä¿¡æ¯ -->
            <div class="player-info my-info">
                <div class="player-avatar my-avatar">ğŸ‘¤</div>
                <h3 id="my-nickname" class="text-xl font-bold mb-2">æˆ‘</h3>
                <div class="space-y-1">
                    <p>æ€»åˆ†: <span id="my-total-score" class="font-bold text-2xl">8</span></p>
                    <p>ç”¨æ—¶: <span id="my-total-time" class="font-medium">3åˆ†25ç§’</span></p>
                    <p>ç­”å¯¹: <span id="my-correct-answers" class="font-medium">8</span>é¢˜</p>
                </div>
            </div>

            <!-- VS -->
            <div class="vs-divider">VS</div>

            <!-- å¯¹æ‰‹ä¿¡æ¯ -->
            <div class="player-info opponent-info">
                <div class="player-avatar opponent-avatar">ğŸ¤–</div>
                <h3 id="opponent-nickname" class="text-xl font-bold mb-2">å¯¹æ‰‹</h3>
                <div class="space-y-1">
                    <p>æ€»åˆ†: <span id="opponent-total-score" class="font-bold text-2xl">6</span></p>
                    <p>ç”¨æ—¶: <span id="opponent-total-time" class="font-medium">4åˆ†12ç§’</span></p>
                    <p>ç­”å¯¹: <span id="opponent-correct-answers" class="font-medium">6</span>é¢˜</p>
                </div>
            </div>
        </div>

        <!-- 3. å…³å¡è¯¦æƒ… -->
        <div class="level-results">
            <h3 class="text-2xl font-bold mb-4 text-center">å…³å¡è¯¦æƒ…</h3>
            <div id="level-results-container">
                <!-- å…³å¡ç»“æœå°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- 4. é”™é¢˜æ±‡æ€» (ä¿ç•™åŸæœ‰åŠŸèƒ½) -->
        <div id="wrong-answers-section" class="wrong-answers-section">
            <h3 class="text-2xl font-bold mb-4 text-center">é”™é¢˜å›é¡¾</h3>
            <div id="wrong-answers-container" class="wrong-answers-container">
                <!-- é”™é¢˜å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- 5. æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <button id="play-again-button" class="action-button primary-button">
                å†æ¥ä¸€å±€
            </button>
            <button id="back-home-button" class="action-button secondary-button">
                è¿”å›é¦–é¡µ
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        lucide.createIcons();

        // å…ƒç´ å¼•ç”¨
        const resultTitleEl = document.getElementById('result-title');
        const myNicknameEl = document.getElementById('my-nickname');
        const myTotalScoreEl = document.getElementById('my-total-score');
        const myTotalTimeEl = document.getElementById('my-total-time');
        const myCorrectAnswersEl = document.getElementById('my-correct-answers');

        const opponentNicknameEl = document.getElementById('opponent-nickname');
        const opponentTotalScoreEl = document.getElementById('opponent-total-score');
        const opponentTotalTimeEl = document.getElementById('opponent-total-time');
        const opponentCorrectAnswersEl = document.getElementById('opponent-correct-answers');

        const levelResultsContainerEl = document.getElementById('level-results-container');
        const wrongAnswersSectionEl = document.getElementById('wrong-answers-section');
        const wrongAnswersContainerEl = document.getElementById('wrong-answers-container');

        const playAgainButtonEl = document.getElementById('play-again-button');
        const backHomeButtonEl = document.getElementById('back-home-button');

        // å°æ¸¸æˆåç§°æ˜ å°„
        const minigameNames = {
            1: 'è­¦å¯ŸæŠ“å°å·',
            2: 'ç™»å¤©æ¢¯',
            3: 'è¯åŠ›æ‹”æ²³'
        };

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}åˆ†${remainingSeconds.toString().padStart(2, '0')}ç§’`;
        }

        // æ˜¾ç¤ºå¯¹æˆ˜ç»“æœ
        function displayBattleResult(resultData) {
            console.log('æ˜¾ç¤ºå¯¹æˆ˜ç»“æœ:', resultData);

            // æ’­æ”¾ç»“æœéŸ³æ•ˆ
            playBattleSound(resultData.isVictory ? 'challenge_win' : 'challenge_lose');

            // æ›´æ–°èƒœè´Ÿæ ‡é¢˜
            const isVictory = resultData.isVictory;
            if (isVictory) {
                resultTitleEl.innerHTML = `
                    <h1 class="text-4xl md:text-6xl font-bold mb-4">ğŸ† èƒœåˆ©ï¼ğŸ†</h1>
                    <p class="text-xl opacity-75">æ­å–œä½ åœ¨å¯¹æˆ˜ä¸­è·èƒœï¼</p>
                `;
                resultTitleEl.className = 'result-title victory';
            } else {
                resultTitleEl.innerHTML = `
                    <h1 class="text-4xl md:text-6xl font-bold mb-4">ğŸ’ª å¤±è´¥</h1>
                    <p class="text-xl opacity-75">è™½è´¥çŠ¹è£ï¼Œç»§ç»­åŠ æ²¹ï¼</p>
                `;
                resultTitleEl.className = 'result-title defeat';
            }

            // æ›´æ–°ç©å®¶ä¿¡æ¯
            myNicknameEl.textContent = resultData.player.nickname || 'æˆ‘';
            myTotalScoreEl.textContent = resultData.player.totalScore || 0;
            myTotalTimeEl.textContent = formatTime(resultData.player.totalTime || 0);
            myCorrectAnswersEl.textContent = resultData.player.correctAnswers || 0;

            opponentNicknameEl.textContent = resultData.opponent.nickname || 'å¯¹æ‰‹';
            opponentTotalScoreEl.textContent = resultData.opponent.totalScore || 0;
            opponentTotalTimeEl.textContent = formatTime(resultData.opponent.totalTime || 0);
            opponentCorrectAnswersEl.textContent = resultData.opponent.correctAnswers || 0;

            // æ˜¾ç¤ºå…³å¡ç»“æœ
            displayLevelResults(resultData.levelResults || []);

            // æ˜¾ç¤ºé”™é¢˜æ±‡æ€» (ä¿ç•™åŸæœ‰åŠŸèƒ½)
            displayWrongAnswers(resultData.wrongAnswers || []);
        }

        // æ˜¾ç¤ºå…³å¡ç»“æœ
        function displayLevelResults(levelResults) {
            levelResultsContainerEl.innerHTML = '';

            levelResults.forEach((result, index) => {
                const level = index + 1;
                const minigameName = minigameNames[level] || `å…³å¡${level}`;

                const div = document.createElement('div');
                div.className = `level-result-item ${result.result}`;

                let resultIcon = '';
                let resultText = '';

                switch (result.result) {
                    case 'victory':
                        resultIcon = 'âœ“';
                        resultText = 'èƒœåˆ©';
                        break;
                    case 'defeat':
                        resultIcon = 'âœ—';
                        resultText = 'å¤±è´¥';
                        break;
                    case 'draw':
                        resultIcon = '=';
                        resultText = 'å¹³å±€';
                        break;
                    default:
                        resultIcon = '?';
                        resultText = 'æœªçŸ¥';
                }

                div.innerHTML = `
                    <div>
                        <span class="font-bold">å…³å¡${level} (${minigameName}):</span>
                        <span class="ml-2">${result.description || ''}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-2xl mr-2">${resultIcon}</span>
                        <span class="font-bold">${resultText}</span>
                    </div>
                `;

                levelResultsContainerEl.appendChild(div);
            });
        }

        // æ˜¾ç¤ºé”™é¢˜æ±‡æ€» (ä¿ç•™åŸæœ‰åŠŸèƒ½)
        function displayWrongAnswers(wrongAnswers) {
            if (!wrongAnswers || wrongAnswers.length === 0) {
                wrongAnswersSectionEl.style.display = 'none';
                return;
            }

            wrongAnswersSectionEl.style.display = 'block';
            wrongAnswersContainerEl.innerHTML = '';

            wrongAnswers.forEach(item => {
                const div = document.createElement('div');
                div.className = 'wrong-answer-item';

                // å¤„ç†ç”¨æˆ·ç­”æ¡ˆæ˜¾ç¤º
                let userAnswerDisplay = '';
                let userAnswerClass = 'text-red-600 font-semibold';

                if (item.userAnswer === 'TIMEOUT' || item.userAnswer === 'è¶…æ—¶') {
                    userAnswerDisplay = 'è¶…æ—¶';
                    userAnswerClass = 'text-orange-600 font-semibold';
                } else {
                    userAnswerDisplay = item.userAnswer || 'æœªä½œç­”';
                }

                div.innerHTML = `
                    <p class="font-medium text-gray-600">å…³å¡ï¼š<span class="level-number">${item.level}</span></p>
                    <p>é¢˜ç›®ï¼š<span class="question-text">${item.question || 'N/A'}</span></p>
                    <p>æ­£ç¡®ç­”æ¡ˆï¼š<span class="correct-answer text-green-700 font-semibold">${item.correctAnswer || 'N/A'}</span></p>
                    <p>ä½ çš„å›ç­”ï¼š<span class="user-answer ${userAnswerClass}">${userAnswerDisplay}</span></p>
                `;

                wrongAnswersContainerEl.appendChild(div);
            });
        }

        // æ’­æ”¾åŒäººæ¨¡å¼éŸ³æ•ˆ
        function playBattleSound(soundName) {
            try {
                // æ£€æŸ¥æ˜¯å¦å…³é—­éŸ³æ•ˆ
                const soundEnabled = localStorage.getItem('soundEnabled');
                if (soundEnabled === 'false') {
                    return;
                }

                // æ’­æ”¾éŸ³æ•ˆ
                const audio = new Audio(`../audio/${soundName}.wav`);
                audio.volume = 0.5; // è®¾ç½®éŸ³é‡ä¸º50%
                audio.play().catch(error => {
                    console.warn(`æ’­æ”¾éŸ³æ•ˆ ${soundName} å¤±è´¥:`, error);
                });
            } catch (error) {
                console.warn(`åŠ è½½éŸ³æ•ˆ ${soundName} å¤±è´¥:`, error);
            }
        }

        // æŒ‰é’®äº‹ä»¶å¤„ç†
        playAgainButtonEl.addEventListener('click', () => {
            // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
            playBattleSound('click');

            // é‡æ–°å¼€å§‹åŒ¹é…
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({ action: 'navigate', screen: 'battle_info_input' }, '*');
            }
        });

        backHomeButtonEl.addEventListener('click', () => {
            // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
            playBattleSound('click');

            // è¿”å›é¦–é¡µ
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({ action: 'navigate', screen: 'welcome' }, '*');
            }
        });

        // é¡µé¢åŠ è½½æ—¶è·å–ç»“æœæ•°æ®
        window.addEventListener('load', () => {
            // ä»çˆ¶é¡µé¢è·å–å¯¹æˆ˜ç»“æœæ•°æ®
            if (window.parent && window.parent.battleResultData) {
                displayBattleResult(window.parent.battleResultData);
            } else {
                // æ¨¡æ‹Ÿæ•°æ®ç”¨äºæµ‹è¯•
                const mockData = {
                    isVictory: true,
                    player: {
                        nickname: 'æˆ‘',
                        totalScore: 8,
                        totalTime: 205, // 3åˆ†25ç§’
                        correctAnswers: 8
                    },
                    opponent: {
                        nickname: 'å¯¹æ‰‹',
                        totalScore: 6,
                        totalTime: 252, // 4åˆ†12ç§’
                        correctAnswers: 6
                    },
                    levelResults: [
                        { result: 'victory', description: 'è­¦å¯ŸæˆåŠŸæŠ“åˆ°å°å·' },
                        { result: 'defeat', description: 'å¯¹æ‰‹å…ˆåˆ°è¾¾20å±‚' },
                        { result: 'victory', description: 'æˆåŠŸæ‹‰è¿‡8æ ¼çº¿' }
                    ],
                    wrongAnswers: [
                        {
                            level: 2,
                            question: 'world',
                            correctAnswer: 'ä¸–ç•Œ',
                            userAnswer: 'åœ°çƒ'
                        }
                    ]
                };
                displayBattleResult(mockData);
            }
        });

        // ç›‘å¬æ¥è‡ªçˆ¶é¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            if (event.data && event.data.action === 'showBattleResult') {
                displayBattleResult(event.data.payload);
            }
        });

    </script>
</body>
</html>
