<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线状态检查 - 单词闯关</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }
        .status-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="status-card rounded-2xl p-8 max-w-md w-full text-center text-white">
        <div id="statusIcon" class="text-6xl mb-4">🌐</div>
        <h1 class="text-2xl font-bold mb-4">单词闯关游戏</h1>
        <div id="statusMessage" class="text-lg mb-6">检查网络状态...</div>
        
        <div id="statusDetails" class="space-y-3 text-sm opacity-75">
            <div class="flex justify-between">
                <span>网络状态:</span>
                <span id="networkStatus" class="pulse">检查中...</span>
            </div>
            <div class="flex justify-between">
                <span>服务器连接:</span>
                <span id="serverStatus" class="pulse">检查中...</span>
            </div>
            <div class="flex justify-between">
                <span>题库状态:</span>
                <span id="dataStatus" class="pulse">检查中...</span>
            </div>
        </div>
        
        <div id="actionButtons" class="mt-8 space-y-3">
            <button id="retryButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                重新检查
            </button>
            <button id="startGameButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                开始游戏
            </button>
        </div>
        
        <div id="errorDetails" class="mt-6 text-xs text-red-200 hidden">
            <!-- 错误详情将在这里显示 -->
        </div>
    </div>

    <script>
        class OnlineStatusChecker {
            constructor() {
                this.statusIcon = document.getElementById('statusIcon');
                this.statusMessage = document.getElementById('statusMessage');
                this.networkStatus = document.getElementById('networkStatus');
                this.serverStatus = document.getElementById('serverStatus');
                this.dataStatus = document.getElementById('dataStatus');
                this.retryButton = document.getElementById('retryButton');
                this.startGameButton = document.getElementById('startGameButton');
                this.errorDetails = document.getElementById('errorDetails');
                
                this.setupEventListeners();
                this.checkStatus();
            }
            
            setupEventListeners() {
                this.retryButton.addEventListener('click', () => this.checkStatus());
                this.startGameButton.addEventListener('click', () => this.startGame());
                
                // 监听网络状态变化
                window.addEventListener('online', () => this.checkStatus());
                window.addEventListener('offline', () => this.updateNetworkStatus(false));
            }
            
            async checkStatus() {
                this.resetStatus();
                
                // 1. 检查基本网络连接
                this.updateNetworkStatus(navigator.onLine);
                
                if (!navigator.onLine) {
                    this.showOfflineStatus();
                    return;
                }
                
                // 2. 检查服务器连接
                await this.checkServerConnection();
                
                // 3. 检查题库数据
                await this.checkDataAvailability();
                
                // 4. 更新最终状态
                this.updateFinalStatus();
            }
            
            resetStatus() {
                this.statusIcon.textContent = '🌐';
                this.statusMessage.textContent = '检查网络状态...';
                this.networkStatus.textContent = '检查中...';
                this.serverStatus.textContent = '检查中...';
                this.dataStatus.textContent = '检查中...';
                this.retryButton.disabled = true;
                this.startGameButton.disabled = true;
                this.errorDetails.classList.add('hidden');
                
                // 添加脉冲动画
                [this.networkStatus, this.serverStatus, this.dataStatus].forEach(el => {
                    el.classList.add('pulse');
                });
            }
            
            updateNetworkStatus(isOnline) {
                this.networkStatus.classList.remove('pulse');
                if (isOnline) {
                    this.networkStatus.textContent = '✅ 已连接';
                    this.networkStatus.className = 'text-green-300';
                } else {
                    this.networkStatus.textContent = '❌ 未连接';
                    this.networkStatus.className = 'text-red-300';
                }
            }
            
            async checkServerConnection() {
                this.serverStatus.classList.remove('pulse');
                try {
                    // 尝试获取主页面来检查服务器连接
                    const response = await fetch('/', { 
                        method: 'HEAD',
                        cache: 'no-cache',
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    if (response.ok) {
                        this.serverStatus.textContent = '✅ 正常';
                        this.serverStatus.className = 'text-green-300';
                        return true;
                    } else {
                        throw new Error(`服务器响应错误: ${response.status}`);
                    }
                } catch (error) {
                    this.serverStatus.textContent = '❌ 异常';
                    this.serverStatus.className = 'text-red-300';
                    this.showError(`服务器连接失败: ${error.message}`);
                    return false;
                }
            }
            
            async checkDataAvailability() {
                this.dataStatus.classList.remove('pulse');
                try {
                    // 尝试多个可能的路径
                    const testPaths = [
                        'data/renjiaoban/grade3.json',
                        './data/renjiaoban/grade3.json',
                        '/data/renjiaoban/grade3.json'
                    ];

                    let lastError = null;

                    for (const path of testPaths) {
                        try {
                            console.log(`尝试访问路径: ${path}`);
                            const response = await fetch(path, {
                                method: 'HEAD',
                                cache: 'no-cache',
                                signal: AbortSignal.timeout(5000)
                            });

                            if (response.ok) {
                                this.dataStatus.textContent = '✅ 可用';
                                this.dataStatus.className = 'text-green-300';
                                this.showError(`题库文件访问成功，使用路径: ${path}`);
                                return true;
                            } else {
                                lastError = `路径 ${path}: HTTP ${response.status}`;
                                console.log(lastError);
                            }
                        } catch (error) {
                            lastError = `路径 ${path}: ${error.message}`;
                            console.log(lastError);
                        }
                    }

                    throw new Error(`所有路径都无法访问。最后错误: ${lastError}`);

                } catch (error) {
                    this.dataStatus.textContent = '❌ 不可用';
                    this.dataStatus.className = 'text-red-300';
                    this.showError(`题库数据检查失败: ${error.message}`);
                    return false;
                }
            }
            
            showOfflineStatus() {
                this.statusIcon.textContent = '📱';
                this.statusMessage.textContent = '离线模式';
                this.serverStatus.textContent = '⏸️ 跳过';
                this.dataStatus.textContent = '⏸️ 跳过';
                this.retryButton.disabled = false;
                this.showError('设备处于离线状态，游戏需要网络连接才能正常运行。');
            }
            
            updateFinalStatus() {
                const networkOk = this.networkStatus.textContent.includes('✅');
                const serverOk = this.serverStatus.textContent.includes('✅');
                const dataOk = this.dataStatus.textContent.includes('✅');
                
                if (networkOk && serverOk && dataOk) {
                    this.statusIcon.textContent = '🎮';
                    this.statusIcon.classList.add('bounce-in');
                    this.statusMessage.textContent = '一切就绪，可以开始游戏！';
                    this.startGameButton.disabled = false;
                } else {
                    this.statusIcon.textContent = '⚠️';
                    this.statusMessage.textContent = '检测到问题，请检查网络连接';
                }
                
                this.retryButton.disabled = false;
            }
            
            showError(message) {
                this.errorDetails.textContent = message;
                this.errorDetails.classList.remove('hidden');
            }
            
            startGame() {
                // 跳转到主游戏页面
                window.location.href = '/index.html';
            }
        }
        
        // 页面加载完成后开始检查
        document.addEventListener('DOMContentLoaded', () => {
            new OnlineStatusChecker();
        });
    </script>
</body>
</html>
