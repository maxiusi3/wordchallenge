<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿çŠ¶æ€æ£€æŸ¥ - å•è¯é—¯å…³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }
        .status-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="status-card rounded-2xl p-8 max-w-md w-full text-center text-white">
        <div id="statusIcon" class="text-6xl mb-4">ğŸŒ</div>
        <h1 class="text-2xl font-bold mb-4">å•è¯é—¯å…³æ¸¸æˆ</h1>
        <div id="statusMessage" class="text-lg mb-6">æ£€æŸ¥ç½‘ç»œçŠ¶æ€...</div>
        
        <div id="statusDetails" class="space-y-3 text-sm opacity-75">
            <div class="flex justify-between">
                <span>ç½‘ç»œçŠ¶æ€:</span>
                <span id="networkStatus" class="pulse">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="flex justify-between">
                <span>æœåŠ¡å™¨è¿æ¥:</span>
                <span id="serverStatus" class="pulse">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="flex justify-between">
                <span>é¢˜åº“çŠ¶æ€:</span>
                <span id="dataStatus" class="pulse">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>
        
        <div id="actionButtons" class="mt-8 space-y-3">
            <button id="retryButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                é‡æ–°æ£€æŸ¥
            </button>
            <button id="startGameButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                å¼€å§‹æ¸¸æˆ
            </button>
        </div>
        
        <div id="errorDetails" class="mt-6 text-xs text-red-200 hidden">
            <!-- é”™è¯¯è¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <script>
        class OnlineStatusChecker {
            constructor() {
                this.statusIcon = document.getElementById('statusIcon');
                this.statusMessage = document.getElementById('statusMessage');
                this.networkStatus = document.getElementById('networkStatus');
                this.serverStatus = document.getElementById('serverStatus');
                this.dataStatus = document.getElementById('dataStatus');
                this.retryButton = document.getElementById('retryButton');
                this.startGameButton = document.getElementById('startGameButton');
                this.errorDetails = document.getElementById('errorDetails');
                
                this.setupEventListeners();
                this.checkStatus();
            }
            
            setupEventListeners() {
                this.retryButton.addEventListener('click', () => this.checkStatus());
                this.startGameButton.addEventListener('click', () => this.startGame());
                
                // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
                window.addEventListener('online', () => this.checkStatus());
                window.addEventListener('offline', () => this.updateNetworkStatus(false));
            }
            
            async checkStatus() {
                this.resetStatus();
                
                // 1. æ£€æŸ¥åŸºæœ¬ç½‘ç»œè¿æ¥
                this.updateNetworkStatus(navigator.onLine);
                
                if (!navigator.onLine) {
                    this.showOfflineStatus();
                    return;
                }
                
                // 2. æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
                await this.checkServerConnection();
                
                // 3. æ£€æŸ¥é¢˜åº“æ•°æ®
                await this.checkDataAvailability();
                
                // 4. æ›´æ–°æœ€ç»ˆçŠ¶æ€
                this.updateFinalStatus();
            }
            
            resetStatus() {
                this.statusIcon.textContent = 'ğŸŒ';
                this.statusMessage.textContent = 'æ£€æŸ¥ç½‘ç»œçŠ¶æ€...';
                this.networkStatus.textContent = 'æ£€æŸ¥ä¸­...';
                this.serverStatus.textContent = 'æ£€æŸ¥ä¸­...';
                this.dataStatus.textContent = 'æ£€æŸ¥ä¸­...';
                this.retryButton.disabled = true;
                this.startGameButton.disabled = true;
                this.errorDetails.classList.add('hidden');
                
                // æ·»åŠ è„‰å†²åŠ¨ç”»
                [this.networkStatus, this.serverStatus, this.dataStatus].forEach(el => {
                    el.classList.add('pulse');
                });
            }
            
            updateNetworkStatus(isOnline) {
                this.networkStatus.classList.remove('pulse');
                if (isOnline) {
                    this.networkStatus.textContent = 'âœ… å·²è¿æ¥';
                    this.networkStatus.className = 'text-green-300';
                } else {
                    this.networkStatus.textContent = 'âŒ æœªè¿æ¥';
                    this.networkStatus.className = 'text-red-300';
                }
            }
            
            async checkServerConnection() {
                this.serverStatus.classList.remove('pulse');
                try {
                    // å°è¯•è·å–ä¸»é¡µé¢æ¥æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
                    const response = await fetch('/', { 
                        method: 'HEAD',
                        cache: 'no-cache',
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    if (response.ok) {
                        this.serverStatus.textContent = 'âœ… æ­£å¸¸';
                        this.serverStatus.className = 'text-green-300';
                        return true;
                    } else {
                        throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`);
                    }
                } catch (error) {
                    this.serverStatus.textContent = 'âŒ å¼‚å¸¸';
                    this.serverStatus.className = 'text-red-300';
                    this.showError(`æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`);
                    return false;
                }
            }
            
            async checkDataAvailability() {
                this.dataStatus.classList.remove('pulse');
                try {
                    // å°è¯•å¤šä¸ªå¯èƒ½çš„è·¯å¾„
                    const testPaths = [
                        'data/renjiaoban/grade3.json',
                        './data/renjiaoban/grade3.json',
                        '/data/renjiaoban/grade3.json'
                    ];

                    let lastError = null;

                    for (const path of testPaths) {
                        try {
                            console.log(`å°è¯•è®¿é—®è·¯å¾„: ${path}`);
                            const response = await fetch(path, {
                                method: 'HEAD',
                                cache: 'no-cache',
                                signal: AbortSignal.timeout(5000)
                            });

                            if (response.ok) {
                                this.dataStatus.textContent = 'âœ… å¯ç”¨';
                                this.dataStatus.className = 'text-green-300';
                                this.showError(`é¢˜åº“æ–‡ä»¶è®¿é—®æˆåŠŸï¼Œä½¿ç”¨è·¯å¾„: ${path}`);
                                return true;
                            } else {
                                lastError = `è·¯å¾„ ${path}: HTTP ${response.status}`;
                                console.log(lastError);
                            }
                        } catch (error) {
                            lastError = `è·¯å¾„ ${path}: ${error.message}`;
                            console.log(lastError);
                        }
                    }

                    throw new Error(`æ‰€æœ‰è·¯å¾„éƒ½æ— æ³•è®¿é—®ã€‚æœ€åé”™è¯¯: ${lastError}`);

                } catch (error) {
                    this.dataStatus.textContent = 'âŒ ä¸å¯ç”¨';
                    this.dataStatus.className = 'text-red-300';
                    this.showError(`é¢˜åº“æ•°æ®æ£€æŸ¥å¤±è´¥: ${error.message}`);
                    return false;
                }
            }
            
            showOfflineStatus() {
                this.statusIcon.textContent = 'ğŸ“±';
                this.statusMessage.textContent = 'ç¦»çº¿æ¨¡å¼';
                this.serverStatus.textContent = 'â¸ï¸ è·³è¿‡';
                this.dataStatus.textContent = 'â¸ï¸ è·³è¿‡';
                this.retryButton.disabled = false;
                this.showError('è®¾å¤‡å¤„äºç¦»çº¿çŠ¶æ€ï¼Œæ¸¸æˆéœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚');
            }
            
            updateFinalStatus() {
                const networkOk = this.networkStatus.textContent.includes('âœ…');
                const serverOk = this.serverStatus.textContent.includes('âœ…');
                const dataOk = this.dataStatus.textContent.includes('âœ…');
                
                if (networkOk && serverOk && dataOk) {
                    this.statusIcon.textContent = 'ğŸ®';
                    this.statusIcon.classList.add('bounce-in');
                    this.statusMessage.textContent = 'ä¸€åˆ‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æ¸¸æˆï¼';
                    this.startGameButton.disabled = false;
                } else {
                    this.statusIcon.textContent = 'âš ï¸';
                    this.statusMessage.textContent = 'æ£€æµ‹åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                }
                
                this.retryButton.disabled = false;
            }
            
            showError(message) {
                this.errorDetails.textContent = message;
                this.errorDetails.classList.remove('hidden');
            }
            
            startGame() {
                // è·³è½¬åˆ°ä¸»æ¸¸æˆé¡µé¢
                window.location.href = '/index.html';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            new OnlineStatusChecker();
        });
    </script>
</body>
</html>
